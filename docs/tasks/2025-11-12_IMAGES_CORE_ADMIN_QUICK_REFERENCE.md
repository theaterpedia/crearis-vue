# ImagesCoreAdmin Quick Reference

**For Developers Working with ImagesCoreAdmin.vue**

---

## ViewMode System

### Three Modes
```typescript
type ViewMode = 'browse' | 'core' | 'shape'
```

**Browse:** View-only, image selection, filtering  
**Core:** Edit core fields (name, status, alt_text, url, etc.)  
**Shape:** Edit shape data (x, y, z, url, tpar, turl, json, blur)

### Travel Rules
```
Browse → Core:      Direct (Edit button)
Browse → Shape:     Bypass through Core
Core → Shape:       Direct (click ImgShape)
Shape → Core:       Direct (Back button)
Any → Browse:       Reset (select different image)
```

### Transition Functions
- `enterBrowseMode()` - Exit current mode, return to browse
- `enterCoreMode()` - Enter edit mode for core fields
- `enterShapeMode(shape, adapter)` - Enter edit mode for specific shape
- `exitShapeMode()` - Return to core mode from shape
- `handleCoreExit()` - Handle exit from core with dirty check
- `handleShapeExit()` - Handle exit from shape with dirty check

---

## Data Architecture

### Facade Fields (Display)
**JSONB fields, read-only, auto-generated by DB trigger**

```typescript
// Used by ImgShape components
img_thumb: { type, url, blur, etc. }
img_square: { type, url, blur, etc. }
img_wide: { type, url, blur, etc. }
img_vertical: { type, url, blur, etc. }
```

### Composite Type Fields (Edit)
**Source data, writable by admin**

```typescript
// Used by ShapeEditor
shape_thumb: { x, y, z, url, tpar, turl, json, blur }
shape_square: { x, y, z, url, tpar, turl, json, blur }
shape_wide: { x, y, z, url, tpar, turl, json, blur }
shape_vertical: { x, y, z, url, tpar, turl, json, blur }
```

### Data Flow
```
Admin edits shape_* → Save → DB trigger → Auto-update img_* → Public site reads img_*
```

---

## Dirty Detection

### Core isDirty
```typescript
const isDirty = ref(false)

// Compares:
// - status_id, name, alt_text, xmlid, url
// - ctags, rtags (Uint8Array comparison)
// - author object (adapter, file_id, etc.)
```

**Trigger:** `checkDirty()` called on all field @input/@change  
**Display:** Save/Cancel buttons in topnav when dirty

### Shape isDirty
```typescript
const shapeIsDirty = computed(() => {
  // Compare originalShapeData with current data
  // All 8 fields: x, y, z, url, tpar, turl, json, blur
})
```

**Storage:** `originalShapeData` set on `enterShapeMode()`  
**Display:** Save/Cancel buttons in topnav when dirty

---

## Edit Behavior

### Three Options
```typescript
type EditBehavior = 'autosave' | 'autocancel' | 'prompt'
const editBehavior = ref<EditBehavior>('prompt')
```

**Prompt:** Ask user before exiting with unsaved changes  
**Autosave:** Automatically save changes on exit  
**Autocancel:** Automatically discard changes on exit

**Persistence:** Saved to `localStorage.imagesCoreAdmin.editBehavior`  
**UI Control:** Settings dropdown in topnav menu

---

## Hero Preview

### Device Mockup Modes
```typescript
type HeroPreviewMode = 'desktop' | 'mobile-50' | 'mobile-100' | 'tablet'
const heroPreviewMode = ref<HeroPreviewMode>('desktop')
```

**Click to cycle:** Desktop → Mobile 50% → Mobile 100% → Tablet  
**Column 2 hidden:** When `heroPreviewMode === 'tablet'`  
**Indicators:** Dual badges show mode (blue) and shape (green)

### Shape Selection
```typescript
type HeroPreviewShape = 'wide' | 'square' | 'vertical'
const heroPreviewShape = ref<HeroPreviewShape>('wide')
```

**Updates:** When ImgShape @activate event fires  
**Excluded:** Thumb shape (too small for hero display)

---

## Component Communication

### ShapeEditor Events
```typescript
// From ShapeEditor to ImagesCoreAdmin
@update="handleShapeUpdate"   // Field changed
@preview="handleShapePreview"  // Preview button clicked
@reset="handleShapeReset"      // Reset button clicked
```

### ShapeEditor Exposed Methods
```typescript
// Access via ref
const shapeEditorRef = ref()
const data = shapeEditorRef.value?.getCurrentData()
// Returns: { x, y, z, url, tpar, turl, json, blur }
```

### ImgShape Events
```typescript
// From ImgShape to ImagesCoreAdmin
@activate="handleShapeActivate"  // Shape clicked (when editable)
@shapeUrl="(url) => ..."         // Shape URL computed
```

### ImgShape Exposed Methods
```typescript
// Access via ref
const imgShapeRef = ref()
imgShapeRef.value.getPreviewData()    // Get preview state
imgShapeRef.value.updatePreview(url, xyz, mode)  // Set preview
imgShapeRef.value.resetPreview()      // Clear preview
```

---

## Key Functions

### Image Selection
```typescript
selectImage(image: any)
// Handles: ViewMode reset, dirty check, shape clearing
```

### Save Operations
```typescript
saveChanges()        // Save core + all shapes
saveShapeChanges()   // Save shape, stay in shape mode
```

### Cancel Operations
```typescript
cancelEdits()        // Restore originalImage
cancelShapeEdits()   // Restore originalShapeData
```

### Shape Management
```typescript
handleShapeActivate(data)   // Shape clicked
handleShapeUpdate(data)     // Shape field changed
handleShapePreview()        // Preview button
handleShapeReset()          // Reset button
```

### Helper Functions
```typescript
detectShapeAdapter(shape)   // Auto-detect adapter from URL
getActiveShapeRef()         // Get ImgShape ref for active shape
parseImageData(jsonb)       // Parse facade field JSONB
```

---

## Computed Properties

### Active Shape Data
```typescript
const activeShapeData = computed(() => {
  // Returns shape_* field for active shape
  // Used by ShapeEditor
})

const activeShapeXYZ = computed(() => {
  // Returns { x, y, z } for active shape
  // Reads from wideX/wideY/wideZ refs
})
```

### Hero Preview URL
```typescript
const heroPreviewUrl = computed(() => {
  // Returns img_* facade URL for hero display
  // Based on heroPreviewShape value
})
```

---

## State Management

### Image State
```typescript
const images = ref<any[]>([])           // All images
const selectedImage = ref<any | null>(null)  // Current image
const originalImage = ref<any | null>(null)  // For cancel operation
```

### Shape XYZ State (Isolated)
```typescript
// Wide shape
const wideX = ref<number | null>(null)
const wideY = ref<number | null>(null)
const wideZ = ref<number | null>(null)

// Square shape
const squareX = ref<number | null>(null)
// ... etc for vertical, thumb
```

**Why separate refs?** Each shape maintains independent XYZ values during editing.

---

## CSS Classes

### ViewMode-Specific
```css
.topnav-browse     /* Browse mode topnav */
.topnav-core       /* Core mode topnav */
.topnav-shape      /* Shape mode topnav */
```

### Dirty State
```css
.btn-save.dirty    /* Save button when changes exist */
.no-changes-indicator  /* "No changes" text */
```

### Hero Preview
```css
.hero-indicators   /* Badge container */
.indicator-badge.mode-badge   /* Blue mode badge */
.indicator-badge.shape-badge  /* Green shape badge */
```

---

## Common Patterns

### Adding New Core Field
1. Add field to template (Column 4, Core mode section)
2. Add v-model binding
3. Add @input="checkDirty()" handler
4. Update checkDirty() comparison object
5. Test dirty detection

### Adding New Shape Field
1. Add field to ShapeEditor.vue Props interface
2. Add field to Direct mode UI
3. Add update handler (updateFieldName)
4. Add to originalShapeData capture
5. Add to shapeIsDirty comparison
6. Add to saveShapeChanges update
7. Add to cancelShapeEdits restore
8. Test dirty detection

### Adding New ViewMode
1. Add mode to ViewMode type
2. Create enter/exit functions
3. Add topnav section
4. Add Column 4 content section
5. Update travel rules
6. Add dirty detection (if needed)
7. Test all transitions

---

## Debugging Tips

### Check ViewMode State
```javascript
// In browser console
viewMode.value  // Current mode
activeShape.value  // Active shape data
isDirty.value  // Core dirty flag
shapeIsDirty.value  // Shape dirty flag
```

### Check Original Data
```javascript
originalImage.value  // For cancel comparison
originalShapeData.value  // For shape cancel
```

### Check XYZ State
```javascript
wideX.value  // Wide shape X
activeShapeXYZ.value  // Active shape XYZ
```

### Trigger Functions Manually
```javascript
checkDirty()  // Force dirty check
enterShapeMode('wide', 'unsplash')  // Enter shape mode
saveChanges()  // Save all changes
```

---

## Performance Considerations

### Computed Properties
- Cached until dependencies change
- Use for derived state (activeShapeData, heroPreviewUrl)

### Watch Functions
- Use for side effects (localStorage, XYZ defaults)
- Keep logic minimal

### Dirty Detection
- JSON.stringify comparison is fast for small objects
- Runs on every field input
- Consider debouncing if performance issues arise

---

## Common Issues

### Issue: isDirty not updating
**Check:** Is `checkDirty()` called on field @input?  
**Check:** Is field included in checkDirty() comparison object?

### Issue: Shape changes not saving
**Check:** Is shapeIsDirty true?  
**Check:** Is activeShapeData populated?  
**Check:** Is saveShapeChanges() actually called?

### Issue: ViewMode transitions not working
**Check:** Are travel rules followed?  
**Check:** Is dirty check blocking transition?  
**Check:** Is editBehavior handled correctly?

### Issue: ImgShape not displaying
**Check:** Is image.img_* field populated? (Not shape_*)  
**Check:** Is parseImageData() called?  
**Check:** Is ImgShape receiving correct props?

---

## References

- **Full Plan:** `/tasks/IMAGES_CORE_ADMIN_REFACTORING_PLAN.md`
- **Testing:** `/tasks/IMAGES_CORE_ADMIN_TESTING_CHECKLIST.md`
- **Summary:** `/tasks/IMAGES_CORE_ADMIN_REFACTORING_SUMMARY.md`
- **Source:** `/src/views/admin/ImagesCoreAdmin.vue`

---

**Last Updated:** November 12, 2025  
**Maintainer:** Development Team
